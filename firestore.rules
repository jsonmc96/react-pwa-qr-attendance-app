rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    /**
     * Verifica si el usuario está autenticado
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Obtiene los datos del usuario desde Firestore
     * NOTA: Esta función hace una lectura extra, úsala con cuidado
     */
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    /**
     * Verifica si el usuario autenticado es admin
     * Requiere que el documento del usuario exista en /users/{uid}
     */
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }
    
    /**
     * Verifica si el usuario autenticado es el dueño del recurso
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    /**
     * Obtiene la fecha actual en formato YYYY-MM-DD
     * NOTA: Firestore no tiene función nativa para formatear fechas,
     * por lo que validamos que la fecha esté dentro de un rango razonable
     */
    function isToday(dateString) {
      // Validar que la fecha no sea futura (más de 1 día adelante)
      let tomorrow = request.time.toMillis() + 86400000; // +1 día en milisegundos
      let yesterday = request.time.toMillis() - 86400000; // -1 día en milisegundos
      
      // Convertir dateString a timestamp aproximado (medianoche UTC)
      // Formato esperado: "YYYY-MM-DD"
      let parts = dateString.split('-');
      let year = int(parts[0]);
      let month = int(parts[1]);
      let day = int(parts[2]);
      
      // Validar que sea una fecha válida
      return year >= 2020 && year <= 2030 &&
             month >= 1 && month <= 12 &&
             day >= 1 && day <= 31;
    }
    
    // ========================================
    // COLLECTION: users
    // ========================================
    // Estructura:
    // {
    //   uid: string (igual al document ID)
    //   email: string
    //   displayName: string
    //   role: "admin" | "user"
    // }
    // ========================================
    
    match /users/{userId} {
      // Lectura: Cualquier usuario autenticado puede leer perfiles básicos
      // (necesario para funcionalidad de ranking)
      // Admin puede leer todos, usuarios pueden leer cualquier perfil
      allow read: if isAuthenticated();
      
      // Escritura: Bloqueada desde el cliente
      // Los usuarios se crean manualmente en Firebase Console o via Admin SDK
      allow write: if false;
    }
    
    // ========================================
    // COLLECTION: dailyQR
    // ========================================
    // Estructura:
    // {
    //   qrHash: string (hash del QR del día)
    //   date: string (YYYY-MM-DD)
    //   createdAt: timestamp
    //   createdBy: string (UID del admin que lo creó)
    // }
    // Document ID: YYYY-MM-DD (ejemplo: 2026-01-19)
    // ========================================
    
    match /dailyQR/{date} {
      // Lectura: Cualquier usuario autenticado puede leer el QR del día
      allow read: if isAuthenticated();
      
      // Crear/Actualizar: Solo admin puede generar/regenerar QR
      allow create, update: if isAdmin();
      
      // Eliminar: Bloqueado para mantener historial
      allow delete: if false;
    }
    
    // ========================================
    // COLLECTION: attendance
    // ========================================
    // Estructura:
    // {
    //   userId: string (UID del usuario)
    //   date: string (YYYY-MM-DD)
    //   timestamp: timestamp (momento exacto del registro)
    //   qrHash: string (hash del QR escaneado)
    // }
    // Document ID: {userId}_{date} (ejemplo: abc123_2026-01-19)
    // ========================================
    
    match /attendance/{attendanceId} {
      // Lectura: Cualquier usuario autenticado puede leer registros de asistencia
      // (necesario para funcionalidad de ranking que usa getCountFromServer)
      // Esto permite queries de agregación sin exponer datos sensibles
      allow read: if isAuthenticated();
      
      // Crear: Usuario puede registrar asistencia SOLO si:
      // 1. Está autenticado
      // 2. El userId en el documento coincide con su UID
      // 3. La fecha es válida (formato YYYY-MM-DD, año razonable)
      // 4. El ID del documento sigue el formato userId_fecha
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       isToday(request.resource.data.date) &&
                       attendanceId == request.auth.uid + '_' + request.resource.data.date;
      
      // Actualizar/Eliminar: Bloqueado para garantizar inmutabilidad
      // Una vez registrada la asistencia, no se puede modificar ni eliminar
      allow update, delete: if false;
    }
    
    // ========================================
    // REGLAS ADICIONALES (Opcional)
    // ========================================
    
    // Si en el futuro necesitas una colección de reportes para admin:
    // match /reports/{reportId} {
    //   allow read, write: if isAdmin();
    // }
    
    // Si necesitas una colección de configuración global:
    // match /config/{configId} {
    //   allow read: if isAuthenticated();
    //   allow write: if isAdmin();
    // }
  }
}
